---
name: Upload API Endpoints
status: open
created: 2026-02-25T02:28:43Z
updated: 2026-02-25T02:41:06Z
github: https://github.com/B30780/AOI_inference_agent/issues/5
depends_on: [2, 3, 4]
parallel: false
conflicts_with: []
---

# Task: Upload API Endpoints

## Description
Implement the upload API endpoints (single and batch) that integrate the SegFormer client, storage service, and database services to handle image uploads, process them through the external service, and store all results in the database.

## Acceptance Criteria
- [ ] POST /upload endpoint implemented for single image upload
- [ ] POST /upload/batch endpoint implemented for multiple images
- [ ] Request validation using Pydantic models
- [ ] Integration with SegFormer client service
- [ ] Integration with storage service for file management
- [ ] Database service created in app/services/db_service.py with CRUD operations
- [ ] Complete workflow: upload ??validate ??call external service ??save results ??store in DB ??return response
- [ ] Transaction management with rollback on errors
- [ ] Proper error handling with meaningful HTTP status codes
- [ ] Response includes result JSON, image URLs/base64, and metadata
- [ ] Batch upload tracks progress and handles partial failures
- [ ] API tests written for both endpoints

## Technical Details

**Database Service (app/services/db_service.py):**

```python
from sqlalchemy.orm import Session
from app.models.database import Image, Class, Region
from typing import List, Dict
import uuid

class DBService:
    def __init__(self, db: Session):
        self.db = db
        
    def create_image_record(self, data: Dict) -> Image:
        """Create image record in database."""
        image = Image(
            img_unique_id=data['img_unique_id'],
            image_height=data['image_height'],
            image_width=data['image_width'],
            processing_time_seconds=data['processing_time_seconds'],
            timestamp=data['timestamp'],
            input_image_path=data['input_image_path'],
            result_image_1_path=data.get('result_image_1_path'),
            result_image_2_path=data.get('result_image_2_path'),
            result_image_3_path=data.get('result_image_3_path')
        )
        self.db.add(image)
        self.db.commit()
        self.db.refresh(image)
        return image
        
    def create_class_records(
        self, 
        img_unique_id: str, 
        classes_data: Dict
    ) -> List[Class]:
        """Create class records for an image."""
        classes = []
        for class_name, class_info in classes_data.items():
            class_obj = Class(
                class_unique_id=str(uuid.uuid4()),
                img_unique_id=img_unique_id,
                class_id=class_info['class_id'],
                class_name=class_name,
                total_regions=class_info['total_regions'],
                total_area_pixels=class_info['total_area_pixels']
            )
            self.db.add(class_obj)
            classes.append(class_obj)
            
            # Create region records
            self.create_region_records(
                class_obj.class_unique_id,
                img_unique_id,
                class_info['regions']
            )
            
        self.db.commit()
        return classes
        
    def create_region_records(
        self,
        class_unique_id: str,
        img_unique_id: str,
        regions_data: List[Dict]
    ) -> List[Region]:
        """Create region records for a class."""
        # Implementation
        pass
```

**Upload Endpoint (app/api/upload.py):**

```python
from fastapi import APIRouter, UploadFile, File, Depends, HTTPException
from sqlalchemy.orm import Session
from app.services.segformer_client import SegFormerClient
from app.services.storage import StorageService
from app.services.db_service import DBService
from app.models.schemas import UploadResponse
import time

router = APIRouter()

@router.post("/upload", response_model=UploadResponse)
async def upload_single_image(
    image: UploadFile = File(...),
    db: Session = Depends(get_db)
):
    """Upload single image for AOI analysis."""
    start_time = time.time()
    
    try:
        # Save uploaded file
        storage = StorageService()
        file_path = await storage.save_uploaded_file(
            image.file, 
            image.filename
        )
        
        # Call SegFormer service
        segformer = SegFormerClient()
        result = await segformer.infer_image(file_path)
        
        # Save result images
        result_paths = await storage.save_result_images(
            result['images'],
            result['img_unique_id']
        )
        
        # Store in database
        db_service = DBService(db)
        img_record = db_service.create_image_record({
            'img_unique_id': result['img_unique_id'],
            'image_height': result['image_shape']['height'],
            'image_width': result['image_shape']['width'],
            'processing_time_seconds': result['processing_time'],
            'timestamp': datetime.now(),
            'input_image_path': file_path,
            'result_image_1_path': result_paths['combined'],
            'result_image_2_path': result_paths['mask'],
            'result_image_3_path': result_paths['overlay']
        })
        
        # Store classes and regions
        db_service.create_class_records(
            result['img_unique_id'],
            result['classes']
        )
        
        # Build response
        return {
            "success": True,
            "img_unique_id": result['img_unique_id'],
            "processing_time": time.time() - start_time,
            "total_defects": sum(
                c['total_regions'] 
                for c in result['classes'].values()
            ),
            "result": result
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/upload/batch")
async def upload_batch_images(
    images: List[UploadFile] = File(...),
    db: Session = Depends(get_db)
):
    """Upload multiple images for batch processing."""
    # Implementation
    pass
```

**Pydantic Schemas (app/models/schemas.py):**
- UploadResponse
- BatchUploadResponse
- ImageMetadata
- DefectSummary

## Dependencies
- [ ] Task 2 completed (database models)
- [ ] Task 3 completed (SegFormer client)
- [ ] Task 4 completed (storage service)

## Effort Estimate
- Size: L
- Hours: 12-16 hours
- Parallel: false (integrates multiple services)

## Definition of Done
- [ ] Both upload endpoints implemented and tested
- [ ] Database transactions working correctly
- [ ] Error handling covers all failure scenarios
- [ ] Batch upload handles partial failures gracefully
- [ ] API tests written with >80% coverage
- [ ] Integration test with all services working together
- [ ] Response format matches specification
- [ ] Code reviewed

