---
name: Query API Endpoints
status: open
created: 2026-02-25T02:28:43Z
updated: 2026-02-25T02:28:43Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 004]
parallel: true
conflicts_with: []
---

# Task: Query API Endpoints

## Description
Implement query API endpoints that retrieve image data, defect classes, and region information from the database with filtering, pagination, and search capabilities. Include health check and statistics endpoints.

## Acceptance Criteria
- [ ] GET /images endpoint with pagination (page, limit) and filters (start_date, end_date)
- [ ] GET /images/{img_unique_id} endpoint to retrieve specific image metadata
- [ ] GET /images/{img_unique_id}/classes endpoint to get defect classes for an image
- [ ] GET /images/{img_unique_id}/regions endpoint to get all defect regions for an image
- [ ] GET /health endpoint for system health check
- [ ] GET /stats endpoint for system statistics (total images, defect counts)
- [ ] Query methods added to DBService for all retrieval operations
- [ ] Response models defined using Pydantic
- [ ] Efficient database queries with proper indexing
- [ ] API tests for all query endpoints

## Technical Details

**Query Endpoints (app/api/query.py):**

```python
from fastapi import APIRouter, Depends, Query, HTTPException
from sqlalchemy.orm import Session
from typing import Optional
from datetime import date
from app.services.db_service import DBService
from app.models.schemas import (
    ImageListResponse, 
    ImageDetailResponse,
    ClassListResponse,
    RegionListResponse,
    HealthResponse,
    StatsResponse
)

router = APIRouter()

@router.get("/images", response_model=ImageListResponse)
async def list_images(
    page: int = Query(1, ge=1),
    limit: int = Query(10, ge=1, le=100),
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    db: Session = Depends(get_db)
):
    """List all images with pagination and filters."""
    db_service = DBService(db)
    
    images = db_service.get_images(
        page=page,
        limit=limit,
        start_date=start_date,
        end_date=end_date
    )
    
    total = db_service.count_images(
        start_date=start_date,
        end_date=end_date
    )
    
    return {
        "total": total,
        "page": page,
        "limit": limit,
        "images": images
    }

@router.get("/images/{img_unique_id}", response_model=ImageDetailResponse)
async def get_image(
    img_unique_id: str,
    db: Session = Depends(get_db)
):
    """Retrieve specific image details."""
    db_service = DBService(db)
    image = db_service.get_image_by_id(img_unique_id)
    
    if not image:
        raise HTTPException(status_code=404, detail="Image not found")
        
    return image

@router.get("/images/{img_unique_id}/classes", response_model=ClassListResponse)
async def get_image_classes(
    img_unique_id: str,
    db: Session = Depends(get_db)
):
    """Get defect classes for an image."""
    db_service = DBService(db)
    classes = db_service.get_classes_by_image(img_unique_id)
    
    return {
        "img_unique_id": img_unique_id,
        "total_classes": len(classes),
        "classes": classes
    }

@router.get("/images/{img_unique_id}/regions", response_model=RegionListResponse)
async def get_image_regions(
    img_unique_id: str,
    db: Session = Depends(get_db)
):
    """Get all defect regions for an image."""
    db_service = DBService(db)
    regions = db_service.get_regions_by_image(img_unique_id)
    
    return {
        "img_unique_id": img_unique_id,
        "total_regions": len(regions),
        "regions": regions
    }

@router.get("/health", response_model=HealthResponse)
async def health_check(db: Session = Depends(get_db)):
    """System health check."""
    try:
        # Check database connection
        db.execute("SELECT 1")
        db_status = "ok"
    except:
        db_status = "error"
        
    return {
        "status": "ok" if db_status == "ok" else "degraded",
        "database": db_status,
        "timestamp": datetime.now().isoformat()
    }

@router.get("/stats", response_model=StatsResponse)
async def get_stats(db: Session = Depends(get_db)):
    """Get system statistics."""
    db_service = DBService(db)
    
    return {
        "total_images": db_service.count_images(),
        "total_defects": db_service.count_total_defects(),
        "defects_by_class": db_service.get_defects_by_class(),
        "recent_uploads": db_service.count_recent_images(days=7)
    }
```

**DBService Query Methods:**

```python
def get_images(
    self, 
    page: int, 
    limit: int,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None
) -> List[Image]:
    """Get images with pagination and filters."""
    query = self.db.query(Image)
    
    if start_date:
        query = query.filter(Image.timestamp >= start_date)
    if end_date:
        query = query.filter(Image.timestamp <= end_date)
        
    offset = (page - 1) * limit
    return query.offset(offset).limit(limit).all()

def get_image_by_id(self, img_unique_id: str) -> Optional[Image]:
    """Get image by unique ID."""
    return self.db.query(Image).filter(
        Image.img_unique_id == img_unique_id
    ).first()

def get_classes_by_image(self, img_unique_id: str) -> List[Class]:
    """Get all classes for an image."""
    return self.db.query(Class).filter(
        Class.img_unique_id == img_unique_id
    ).all()

def get_regions_by_image(self, img_unique_id: str) -> List[Region]:
    """Get all regions for an image."""
    return self.db.query(Region).filter(
        Region.img_unique_id == img_unique_id
    ).all()

def count_images(
    self,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None
) -> int:
    """Count images with optional filters."""
    # Implementation
    pass

def count_total_defects(self) -> int:
    """Count total defects across all images."""
    # Implementation
    pass

def get_defects_by_class(self) -> Dict[str, int]:
    """Get defect counts grouped by class."""
    # Implementation
    pass
```

## Dependencies
- [ ] Task 001 completed (database models)
- [ ] Task 004 completed (upload endpoints create data to query)

## Effort Estimate
- Size: M
- Hours: 8-10 hours
- Parallel: true (can be developed alongside download endpoints)

## Definition of Done
- [ ] All query endpoints implemented
- [ ] Pagination working correctly
- [ ] Filters applied properly
- [ ] Database queries optimized
- [ ] Response models match specification
- [ ] API tests written with >80% coverage
- [ ] Health check functional
- [ ] Statistics accurate
- [ ] Code reviewed
