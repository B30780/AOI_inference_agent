---
name: Testing Suite
status: open
created: 2026-02-25T02:28:43Z
updated: 2026-02-25T02:28:43Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002, 003, 004, 005, 006]
parallel: false
conflicts_with: []
---

# Task: Testing Suite

## Description
Develop comprehensive unit and integration tests for all services, API endpoints, and database operations. Achieve >70% code coverage and ensure all critical paths are tested.

## Acceptance Criteria
- [ ] Unit tests written for all services (SegFormer client, storage, database)
- [ ] Integration tests for all API endpoints
- [ ] Test fixtures and mocks created
- [ ] Database tests use test database (separate from production)
- [ ] pytest configuration set up (pytest.ini, conftest.py)
- [ ] Test coverage >70%
- [ ] All tests passing in CI environment
- [ ] Test documentation written
- [ ] Coverage report generated

## Technical Details

**Test Structure:**

```
tests/
├── __init__.py
├── conftest.py              # Shared fixtures
├── test_database.py         # Database model tests
├── test_segformer_client.py # SegFormer client tests
├── test_storage.py          # Storage service tests
├── test_upload_api.py       # Upload endpoint tests
├── test_query_api.py        # Query endpoint tests
├── test_download_api.py     # Download endpoint tests
└── test_integration.py      # Full workflow tests
```

**Pytest Configuration (pytest.ini):**

```ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    --verbose
    --cov=app
    --cov-report=html
    --cov-report=term
    --cov-fail-under=70
```

**Shared Fixtures (conftest.py):**

```python
import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from fastapi.testclient import TestClient
from app.main import app
from app.models.database import Base
from app.config import settings

# Test database URL
TEST_DATABASE_URL = "sqlite:///./test.db"

@pytest.fixture(scope="function")
def db_session():
    """Create test database session."""
    engine = create_engine(TEST_DATABASE_URL)
    Base.metadata.create_all(bind=engine)
    
    TestingSessionLocal = sessionmaker(bind=engine)
    session = TestingSessionLocal()
    
    yield session
    
    session.close()
    Base.metadata.drop_all(bind=engine)

@pytest.fixture(scope="function")
def client(db_session):
    """Create test client with test database."""
    def override_get_db():
        yield db_session
    
    app.dependency_overrides[get_db] = override_get_db
    
    with TestClient(app) as test_client:
        yield test_client
    
    app.dependency_overrides.clear()

@pytest.fixture
def mock_segformer_response():
    """Mock SegFormer service response."""
    return {
        "img_unique_id": "test_img_123",
        "image_shape": {"height": 1792, "width": 1792},
        "processing_time": 1.5,
        "classes": {
            "PI_Particle": {
                "class_id": 1,
                "total_regions": 2,
                "total_area_pixels": 50,
                "regions": [
                    {
                        "region_id": 1,
                        "centroid": {"x": 100.0, "y": 200.0},
                        "bounding_box": {"x": 95, "y": 195, "width": 10, "height": 10},
                        "area_pixels": 25,
                        "perimeter": 20.0,
                        "major_axis": 10.0,
                        "minor_axis": 8.0,
                        "circularity": 0.8,
                        "aspect_ratio": 1.25
                    }
                ]
            }
        }
    }

@pytest.fixture
def sample_image_file():
    """Create sample image file for testing."""
    from PIL import Image
    import io
    
    img = Image.new('RGB', (100, 100), color='red')
    img_bytes = io.BytesIO()
    img.save(img_bytes, format='PNG')
    img_bytes.seek(0)
    
    return img_bytes
```

**Database Tests (test_database.py):**

```python
import pytest
from app.models.database import Image, Class, Region
from datetime import datetime

def test_create_image(db_session):
    """Test creating image record."""
    image = Image(
        img_unique_id="test_123",
        image_height=1792,
        image_width=1792,
        processing_time_seconds=1.5,
        timestamp=datetime.now(),
        input_image_path="/path/to/input.jpg"
    )
    
    db_session.add(image)
    db_session.commit()
    
    retrieved = db_session.query(Image).filter_by(img_unique_id="test_123").first()
    assert retrieved is not None
    assert retrieved.image_height == 1792

def test_cascade_delete(db_session):
    """Test CASCADE delete on foreign keys."""
    # Create image
    image = Image(img_unique_id="test_cascade", ...)
    db_session.add(image)
    db_session.commit()
    
    # Create class
    cls = Class(
        class_unique_id="cls_123",
        img_unique_id="test_cascade",
        ...
    )
    db_session.add(cls)
    db_session.commit()
    
    # Delete image
    db_session.delete(image)
    db_session.commit()
    
    # Verify class was deleted
    assert db_session.query(Class).filter_by(class_unique_id="cls_123").first() is None
```

**SegFormer Client Tests (test_segformer_client.py):**

```python
import pytest
from unittest.mock import AsyncMock, patch
from app.services.segformer_client import SegFormerClient

@pytest.mark.asyncio
async def test_infer_image_success(mock_segformer_response):
    """Test successful image inference."""
    with patch('httpx.AsyncClient.post') as mock_post:
        mock_post.return_value.json.return_value = mock_segformer_response
        mock_post.return_value.raise_for_status = lambda: None
        
        client = SegFormerClient()
        result = await client.infer_image("/path/to/test.jpg")
        
        assert result['img_unique_id'] == "test_img_123"
        assert 'classes' in result

@pytest.mark.asyncio
async def test_infer_image_retry_on_timeout():
    """Test retry logic on timeout."""
    with patch('httpx.AsyncClient.post') as mock_post:
        mock_post.side_effect = [
            httpx.TimeoutException("Timeout"),
            httpx.TimeoutException("Timeout"),
            AsyncMock(json=lambda: {"result": "success"})
        ]
        
        client = SegFormerClient()
        # Should succeed after 2 retries
        result = await client.infer_image("/path/to/test.jpg")
        
        assert mock_post.call_count == 3
```

**Upload API Tests (test_upload_api.py):**

```python
def test_upload_single_image(client, sample_image_file, monkeypatch):
    """Test single image upload endpoint."""
    # Mock external service
    async def mock_infer(self, image_path):
        return {
            "img_unique_id": "test_123",
            "image_shape": {"height": 100, "width": 100},
            # ... mock response
        }
    
    monkeypatch.setattr(
        "app.services.segformer_client.SegFormerClient.infer_image",
        mock_infer
    )
    
    response = client.post(
        "/api/upload",
        files={"image": ("test.png", sample_image_file, "image/png")}
    )
    
    assert response.status_code == 200
    data = response.json()
    assert data["success"] is True
    assert "img_unique_id" in data

def test_upload_invalid_file_type(client):
    """Test upload with invalid file type."""
    response = client.post(
        "/api/upload",
        files={"image": ("test.txt", b"not an image", "text/plain")}
    )
    
    assert response.status_code == 400
```

**Integration Tests (test_integration.py):**

```python
def test_full_workflow(client, db_session, sample_image_file):
    """Test complete upload -> query -> download workflow."""
    # 1. Upload image
    upload_response = client.post(
        "/api/upload",
        files={"image": ("test.png", sample_image_file, "image/png")}
    )
    assert upload_response.status_code == 200
    img_id = upload_response.json()["img_unique_id"]
    
    # 2. Query image
    query_response = client.get(f"/api/images/{img_id}")
    assert query_response.status_code == 200
    
    # 3. Get classes
    classes_response = client.get(f"/api/images/{img_id}/classes")
    assert classes_response.status_code == 200
    
    # 4. Download JSON
    download_response = client.get(f"/api/download/json/{img_id}")
    assert download_response.status_code == 200
```

## Dependencies
- [ ] All previous tasks completed (001-006)

## Effort Estimate
- Size: L
- Hours: 12-16 hours
- Parallel: false (requires implemented code to test)

## Definition of Done
- [ ] All unit tests written and passing
- [ ] All integration tests written and passing
- [ ] Test coverage >70%
- [ ] Coverage report generated
- [ ] No flaky tests
- [ ] Tests run successfully in CI
- [ ] Test documentation complete
- [ ] Code reviewed
