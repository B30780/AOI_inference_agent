---
name: File Storage Service
status: open
created: 2026-02-25T02:28:43Z
updated: 2026-02-25T02:41:06Z
github: https://github.com/B30780/AOI_inference_agent/issues/4
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: File Storage Service

## Description
Implement the file storage manager service that handles saving uploaded images, organizing files by date, saving inference result images, and generating batch ZIP archives. Includes file validation, unique identifier generation, and path resolution.

## Acceptance Criteria
- [ ] Storage service created in app/services/storage.py
- [ ] `save_uploaded_file(file, date_folder) -> str` method saves files to data/uploads/YYYYMMDD/
- [ ] `save_result_images(images_dict, output_folder) -> dict` saves combined/mask/overlay to data/results/YYYYMMDD/
- [ ] `generate_batch_zip(batch_id) -> str` creates ZIP archive of batch results
- [ ] File naming convention: {timestamp}_{unique_id}_{original_name}
- [ ] Automatic directory creation (creates date folders if not exist)
- [ ] File validation implemented in app/utils/validators.py (format, size checks)
- [ ] UUID generation and timestamp formatting in app/utils/helpers.py
- [ ] Path resolution for download requests
- [ ] Unit tests for all storage operations

## Technical Details

**Implementation (app/services/storage.py):**

```python
from pathlib import Path
from datetime import datetime
import uuid
import zipfile
from typing import Dict, BinaryIO
from app.config import settings
from app.utils.validators import validate_file_type, validate_file_size
from app.utils.helpers import generate_unique_id, get_timestamp

class StorageService:
    def __init__(self):
        self.upload_dir = Path(settings.UPLOAD_DIR)
        self.result_dir = Path(settings.RESULT_DIR)
        self._ensure_directories()
        
    def _ensure_directories(self):
        self.upload_dir.mkdir(parents=True, exist_ok=True)
        self.result_dir.mkdir(parents=True, exist_ok=True)
        
    async def save_uploaded_file(self, file: BinaryIO, filename: str) -> str:
        """
        Save uploaded file to date-organized directory.
        
        Returns: Full path to saved file
        """
        # Validate file
        validate_file_type(filename)
        validate_file_size(file)
        
        # Create date folder
        date_str = datetime.now().strftime("%Y%m%d")
        date_dir = self.upload_dir / date_str
        date_dir.mkdir(exist_ok=True)
        
        # Generate unique filename
        unique_id = generate_unique_id()
        timestamp = get_timestamp()
        new_filename = f"{timestamp}_{unique_id}_{filename}"
        
        # Save file
        file_path = date_dir / new_filename
        with open(file_path, 'wb') as f:
            f.write(file.read())
            
        return str(file_path)
        
    async def save_result_images(
        self, 
        images: Dict[str, bytes], 
        img_unique_id: str
    ) -> Dict[str, str]:
        """
        Save inference result images.
        
        Args:
            images: Dict with 'combined', 'mask', 'overlay' keys
            img_unique_id: Unique identifier for this result
            
        Returns: Dict with paths to saved images
        """
        date_str = datetime.now().strftime("%Y%m%d")
        date_dir = self.result_dir / date_str / img_unique_id
        date_dir.mkdir(parents=True, exist_ok=True)
        
        paths = {}
        for img_type, img_data in images.items():
            file_path = date_dir / f"{img_unique_id}_{img_type}.png"
            with open(file_path, 'wb') as f:
                f.write(img_data)
            paths[img_type] = str(file_path)
            
        return paths
        
    async def generate_batch_zip(self, batch_id: str) -> str:
        """Create ZIP archive of batch results."""
        # Implementation
        pass
        
    def get_file_path(self, relative_path: str) -> Path:
        """Resolve relative path to absolute path."""
        # Implementation
        pass
```

**File Validation (app/utils/validators.py):**
- Check file extension against allowed types (JPEG, PNG, TIFF, BMP)
- Validate file size (max 50MB)
- Raise ValidationError with clear messages

**Helpers (app/utils/helpers.py):**
- `generate_unique_id()` -> UUID string
- `get_timestamp()` -> formatted timestamp string
- Other utility functions as needed

## Dependencies
- [ ] Task 2 completed (project structure and config)

## Effort Estimate
- Size: M
- Hours: 6-8 hours
- Parallel: true (can be developed alongside Task 3)

## Definition of Done
- [ ] Storage service implemented with all methods
- [ ] File validation working correctly
- [ ] Directory creation automatic
- [ ] ZIP archive generation tested
- [ ] Unit tests written with >80% coverage
- [ ] No file system errors in edge cases
- [ ] Code reviewed
- [ ] Documentation added for all public methods

