---
name: External Service Integration
status: open
created: 2026-02-25T02:28:43Z
updated: 2026-02-25T02:41:06Z
github: https://github.com/B30780/AOI_inference_agent/issues/3
depends_on: [2]
parallel: false
conflicts_with: []
---

# Task: External Service Integration

## Description
Implement the HTTP client service for communicating with the external SegFormer model service at http://140.96.77.124:8080/. Include retry logic for transient failures, timeout handling, response parsing, and comprehensive error handling.

## Acceptance Criteria
- [ ] SegFormer client service created in app/services/segformer_client.py
- [ ] `async def infer_image(image_path: str) -> dict` method implemented
- [ ] Image sent to external service using httpx with multipart/form-data
- [ ] Response parsed to extract JSON analysis and 3 image files (combined, mask, overlay)
- [ ] Retry logic implemented (3 attempts with exponential backoff: 1s, 2s, 4s)
- [ ] Timeout configured (30 seconds per request)
- [ ] Connection errors handled gracefully with meaningful error messages
- [ ] Response validation ensures all expected fields are present
- [ ] Unit tests written with mocked httpx responses
- [ ] Integration test successfully calls external service (if accessible)

## Technical Details

**Implementation (app/services/segformer_client.py):**

```python
import httpx
from typing import Dict, BinaryIO
import asyncio
from app.config import settings

class SegFormerClient:
    def __init__(self):
        self.base_url = settings.SEGFORMER_SERVICE_URL
        self.timeout = 30.0
        self.max_retries = 3
        
    async def infer_image(self, image_path: str) -> Dict:
        """
        Send image to SegFormer service and return results.
        
        Returns:
            {
                "result_json": {...},
                "combined_image": bytes,
                "mask_image": bytes,
                "overlay_image": bytes
            }
        """
        for attempt in range(self.max_retries):
            try:
                async with httpx.AsyncClient(timeout=self.timeout) as client:
                    with open(image_path, 'rb') as f:
                        files = {'image': f}
                        response = await client.post(
                            f"{self.base_url}/upload",
                            files=files
                        )
                        response.raise_for_status()
                        
                        # Parse response
                        result = response.json()
                        
                        # Extract and validate
                        return self._parse_response(result)
                        
            except httpx.TimeoutException:
                if attempt < self.max_retries - 1:
                    await asyncio.sleep(2 ** attempt)
                    continue
                raise
            except httpx.HTTPError as e:
                # Handle connection errors
                raise
                
    def _parse_response(self, response: dict) -> dict:
        # Validate and extract fields
        pass
```

**Error Handling:**
- Timeout errors: Retry with exponential backoff
- Connection errors: Log and raise with clear message
- HTTP errors (4xx, 5xx): Parse error response and raise
- Response validation: Check for required fields

**Testing:**
- Mock httpx.AsyncClient for unit tests
- Test retry logic with transient failures
- Test timeout handling
- Test error cases (connection refused, timeout, invalid response)

## Dependencies
- [ ] Task 2 completed (project structure and config)
- [ ] Access to external SegFormer service (or mock for testing)

## Effort Estimate
- Size: M
- Hours: 8-10 hours
- Parallel: false (needed by upload tasks)

## Definition of Done
- [ ] SegFormer client implemented with all methods
- [ ] Retry logic working correctly
- [ ] Timeout handling tested
- [ ] Error handling comprehensive
- [ ] Unit tests written with >80% coverage
- [ ] Integration test passes (if service accessible)
- [ ] Code reviewed and follows project conventions
- [ ] Logging added for all external calls

