/**
 * FANOUT Shuttle Service AOI 影像辨識系統 JavaScript
 * Author: ITRI EOSL Rachel A30335
 * Date: 2025-12-02
 */

// ========== 全域變數 ==========
let currentAnalysisData = null;
let currentImageFiles = {
    combined: null,
    overlay: null,
    mask: null
};
let currentZoom = 1.0;
let isGrayscale = false;
let imageCanvas = null;
let imageContext = null;

// ========== 頁面載入初始化 ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('FANOUT AOI System Initialized');
    
    // 檢查系統狀態
    checkSystemStatus();
    
    // 初始化拖拽功能
    initDragAndDrop();
    
    // 初始化文件選擇處理
    initFileSelection();
    
    // 初始化鍵盤快捷鍵
    initKeyboardShortcuts();
    
    // 顯示歡迎訊息
    showStatus('系統已準備就緒，請上傳 AOI 影像進行瑕疵檢測', 'info');
});

// ========== 系統狀態檢查 ==========
function checkSystemStatus() {
    fetch('/health')
        .then(response => response.json())
        .then(data => {
            updateSystemStatus(data);
        })
        .catch(error => {
            console.error('Health check error:', error);
            updateSystemStatus({
                model_loaded: false,
                device: 'unknown',
                status: 'error'
            });
        });
}

function updateSystemStatus(data) {
    // 更新模型狀態
    const modelStatus = document.getElementById('modelStatus');
    const modelIndicator = document.getElementById('modelIndicator');
    
    if (data.model_loaded) {
        modelStatus.innerHTML = '<span class="status-indicator status-online" id="modelIndicator"></span> 已載入';
        modelIndicator.className = 'status-indicator status-online';
    } else {
        modelStatus.innerHTML = '<span class="status-indicator status-offline" id="modelIndicator"></span> 未載入';
        modelIndicator.className = 'status-indicator status-offline';
    }
    
    // 更新設備狀態
    const deviceStatus = document.getElementById('deviceStatus');
    deviceStatus.textContent = data.device === 'cuda' ? 'GPU (CUDA)' : 'CPU';
}

// ========== 拖拽功能 ==========
function initDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    
    // 防止預設行為
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // 高亮顯示
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.add('drag-over');
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.remove('drag-over');
        }, false);
    });
    
    // 處理檔案放置
    uploadArea.addEventListener('drop', handleDrop, false);
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        const fileInput = document.getElementById('imageInput');
        fileInput.files = files;
        showStatus(`已選擇文件: ${files[0].name}`, 'info');
    }
}

// ========== 文件選擇處理 ==========
function initFileSelection() {
    const fileInput = document.getElementById('imageInput');
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            showStatus(`已選擇文件: ${file.name} (${formatFileSize(file.size)})`, 'info');
            
            // 顯示檔案預覽
            previewImage(file);
        }
    });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function previewImage(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        // 可在此處添加影像預覽功能
        console.log('Image loaded for preview');
    };
    reader.readAsDataURL(file);
}

// ========== 影像分析主函數 ==========
function analyzeImage() {
    const fileInput = document.getElementById('imageInput');
    const file = fileInput.files[0];
    
    // 驗證文件
    if (!file) {
        showStatus('請先選擇一張影像', 'error');
        return;
    }
    
    // 驗證文件類型
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp', 'image/tiff'];
    if (!allowedTypes.includes(file.type)) {
        showStatus('不支援的文件格式，請上傳 JPG、PNG、BMP 或 TIFF 格式', 'error');
        return;
    }
    
    // 驗證文件大小 (50MB)
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
        showStatus('文件過大，請確保文件小於 50MB', 'error');
        return;
    }
    
    // 建立 FormData
    const formData = new FormData();
    formData.append('image', file);
    
    // 顯示載入狀態
    showLoading(true);
    hideResults();
    
    // 禁用按鈕
    const analyzeBtn = document.getElementById('analyzeBtn');
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';
    
    // 更新載入詳情
    updateLoadingDetail('上傳影像中...');
    
    // 發送請求
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || '伺服器錯誤');
            });
        }
        return response.json();
    })
    .then(data => {
        updateLoadingDetail('處理完成，正在顯示結果...');
        
        if (data.success) {
            // 儲存分析數據
            currentAnalysisData = data;
            
            // 顯示結果
            displayResults(data);
            showStatus('分析完成！檢測到 ' + data.total_defects + ' 個瑕疵', 'success');
        } else {
            showStatus('分析失敗: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Analysis error:', error);
        showStatus('處理錯誤: ' + error.message, 'error');
    })
    .finally(() => {
        // 恢復按鈕狀態
        showLoading(false);
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-search"></i> 開始分析';
    });
}

// ========== 結果顯示 ==========
function displayResults(data) {
    // 顯示統計卡片
    document.getElementById('totalDefects').textContent = data.total_defects;
    document.getElementById('processingTime').textContent = data.processing_time.toFixed(2) + ' 秒';
    
    // 顯示時間戳
    const timestamp = new Date(data.timestamp);
    document.getElementById('analysisTime').textContent = timestamp.toLocaleString('zh-TW');
    
    // 顯示影像尺寸
    if (data.analysis_results && data.analysis_results.image_shape) {
        const shape = data.analysis_results.image_shape;
        document.getElementById('imageSize').textContent = 
            `${shape.width} × ${shape.height}`;
    }
    
    // 顯示影像
    document.getElementById('combinedImg').src = 'data:image/png;base64,' + data.combined_image;
    document.getElementById('overlayImg').src = 'data:image/png;base64,' + data.overlay_image;
    document.getElementById('maskImg').src = 'data:image/png;base64,' + data.mask_image;
    
    // 儲存 base64 資料供下載使用
    currentImageFiles = {
        combined: data.combined_image,
        overlay: data.overlay_image,
        mask: data.mask_image
    };
    
    // 顯示瑕疵分類統計
    displayDefectSummary(data.analysis_results);
    
    // 顯示結果區域
    showResults();
    
    // 初始化影像檢視器
    setTimeout(() => {
        initImageViewer();
        initMouseWheelZoom();
    }, 100);
}

function displayDefectSummary(analysisResults) {
    const defectList = document.getElementById('defectList');
    defectList.innerHTML = '';
    
    if (!analysisResults || !analysisResults.classes) {
        defectList.innerHTML = '<p>無瑕疵數據</p>';
        return;
    }
    
    // 瑕疵顏色對應
    const defectColors = {
        '1_PI_Particle': '#0000ff',
        '2_PR_Peeling': '#00ff00',
        '3_Copper_Nodule': '#ff0000',
        '4_Env_Particle': '#00ffff'
    };
    
    // 遍歷每個類別
    Object.entries(analysisResults.classes).forEach(([className, classData]) => {
        const defectItem = document.createElement('div');
        defectItem.className = 'defect-item';
        
        const color = defectColors[className] || '#666';
        
        defectItem.innerHTML = `
            <div class="defect-name">
                <i class="fas fa-bug" style="color: ${color};"></i>
                ${className}
            </div>
            <div class="defect-badge">${classData.total_regions}</div>
        `;
        
        defectList.appendChild(defectItem);
    });
}

// ========== 標籤切換 ==========
function switchTab(tabName) {
    // 移除所有 active 類別
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // 添加 active 到選中的標籤
    event.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
}

// ========== 下載功能 ==========
function downloadImage(type) {
    if (!currentImageFiles[type]) {
        showStatus('無可下載的影像', 'error');
        return;
    }
    
    // 建立下載連結
    const link = document.createElement('a');
    link.href = 'data:image/png;base64,' + currentImageFiles[type];
    
    const timestamp = currentAnalysisData.timestamp;
    link.download = `AOI_${type}_${timestamp}.png`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showStatus(`已下載 ${type} 影像`, 'success');
}

function downloadJSON() {
    if (!currentAnalysisData) {
        showStatus('無可下載的分析報告', 'error');
        return;
    }
    
    // 建立 JSON 字串
    const jsonStr = JSON.stringify(currentAnalysisData.analysis_results, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // 建立下載連結
    const link = document.createElement('a');
    link.href = url;
    link.download = `AOI_analysis_${currentAnalysisData.timestamp}.json`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url);
    showStatus('已下載分析報告', 'success');
}

// ========== 清除結果 ==========
function clearResults() {
    // 清除文件選擇
    document.getElementById('imageInput').value = '';
    
    // 隱藏結果
    hideResults();
    
    // 清除狀態訊息
    hideStatus();
    
    // 重置數據
    currentAnalysisData = null;
    currentImageFiles = {
        combined: null,
        overlay: null,
        mask: null
    };
    
    showStatus('已清除結果', 'info');
}

// ========== UI 輔助函數 ==========
function showLoading(show) {
    const loading = document.getElementById('loading');
    if (show) {
        loading.classList.add('show');
    } else {
        loading.classList.remove('show');
    }
}

function updateLoadingDetail(message) {
    const loadingDetail = document.getElementById('loadingDetail');
    if (loadingDetail) {
        loadingDetail.textContent = message;
    }
}

function showResults() {
    const results = document.getElementById('results');
    results.classList.add('show');
    results.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hideResults() {
    const results = document.getElementById('results');
    results.classList.remove('show');
}

function showStatus(message, type) {
    const statusMessage = document.getElementById('statusMessage');
    statusMessage.textContent = message;
    statusMessage.className = 'status-message show ' + type;
    
    // 自動隱藏成功和資訊訊息
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            hideStatus();
        }, 5000);
    }
}

function hideStatus() {
    const statusMessage = document.getElementById('statusMessage');
    statusMessage.classList.remove('show');
}

// ========== 鍵盤快捷鍵 ==========
function initKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + Enter: 開始分析
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            analyzeImage();
        }
        
        // Escape: 清除狀態
        if (e.key === 'Escape') {
            hideStatus();
        }
        
        // Ctrl/Cmd + Delete: 清除結果
        if ((e.ctrlKey || e.metaKey) && e.key === 'Delete') {
            e.preventDefault();
            clearResults();
        }
    });
}

// ========== LLM 功能 (預留) ==========
function sendLLMMessage(message) {
    // TODO: 實作 LLM 聊天功能
    console.log('LLM message:', message);
    
    fetch('/llm/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        console.log('LLM response:', data);
    })
    .catch(error => {
        console.error('LLM error:', error);
    });
}

// ========== 工具函數 ==========
function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

// ========== 影像檢視器功能 ==========

// 初始化影像檢視器
function initImageViewer() {
    const img = document.getElementById('combinedImg');
    const wrapper = document.getElementById('combinedWrapper');
    
    if (!img || !wrapper) return;
    
    // 建立隱藏的 canvas 用於讀取像素值
    if (!imageCanvas) {
        imageCanvas = document.createElement('canvas');
        imageContext = imageCanvas.getContext('2d');
    }
    
    // 當影像載入完成時
    img.onload = function() {
        imageCanvas.width = img.naturalWidth;
        imageCanvas.height = img.naturalHeight;
        imageContext.drawImage(img, 0, 0);
    };
    
    // 滑鼠移動事件
    wrapper.addEventListener('mousemove', function(e) {
        const rect = img.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / currentZoom);
        const y = Math.floor((e.clientY - rect.top) / currentZoom);
        
        // 確保座標在影像範圍內
        if (x >= 0 && x < img.naturalWidth && y >= 0 && y < img.naturalHeight) {
            // 讀取像素值
            const pixelData = imageContext.getImageData(x, y, 1, 1).data;
            const grayscale = Math.round(0.299 * pixelData[0] + 0.587 * pixelData[1] + 0.114 * pixelData[2]);
            
            // 更新座標顯示
            const coordDisplay = document.getElementById('coordinateDisplay');
            coordDisplay.textContent = `X: ${x}, Y: ${y} | 灰階: ${grayscale}`;
        }
    });
    
    // 滑鼠離開時隱藏座標
    wrapper.addEventListener('mouseleave', function() {
        const coordDisplay = document.getElementById('coordinateDisplay');
        coordDisplay.textContent = 'X: -, Y: - | 灰階: -';
    });
}

// 放大功能
function zoomIn() {
    currentZoom = Math.min(currentZoom + 0.25, 5.0);
    applyZoom();
}

// 縮小功能
function zoomOut() {
    currentZoom = Math.max(currentZoom - 0.25, 0.5);
    applyZoom();
}

// 重置縮放
function resetZoom() {
    currentZoom = 1.0;
    applyZoom();
}

// 套用縮放
function applyZoom() {
    const img = document.getElementById('combinedImg');
    if (img) {
        img.style.transform = `scale(${currentZoom})`;
        document.getElementById('zoomLevel').textContent = `${Math.round(currentZoom * 100)}%`;
    }
}

// 切換灰階模式
function toggleGrayscale() {
    isGrayscale = !isGrayscale;
    const wrapper = document.getElementById('combinedWrapper');
    const btn = document.getElementById('grayscaleBtn');
    
    if (isGrayscale) {
        wrapper.classList.add('grayscale');
        btn.style.background = 'var(--secondary-color)';
        btn.style.color = 'white';
    } else {
        wrapper.classList.remove('grayscale');
        btn.style.background = 'white';
        btn.style.color = '#495057';
    }
}

// 滾輪縮放
function initMouseWheelZoom() {
    const wrapper = document.getElementById('combinedWrapper');
    if (!wrapper) return;
    
    wrapper.addEventListener('wheel', function(e) {
        if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        }
    }, { passive: false });
}

// ========== 匯出函數供 HTML 使用 ==========
window.analyzeImage = analyzeImage;
window.clearResults = clearResults;
window.switchTab = switchTab;
window.downloadImage = downloadImage;
window.downloadJSON = downloadJSON;
window.sendLLMMessage = sendLLMMessage;
window.zoomIn = zoomIn;
window.zoomOut = zoomOut;
window.resetZoom = resetZoom;
window.toggleGrayscale = toggleGrayscale;

console.log('FANOUT AOI WebUI JavaScript loaded successfully');
